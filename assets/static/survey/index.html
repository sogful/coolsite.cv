<!DOCTYPE html>

<!--
    feel free to steal this ui, just please credit me lol
    this took a while ðŸ¥²
-->

<html lang="en">
<head>

    <title>&#8203;</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">

    <style>
        @font-face {
            font-family: "determination";
            src: url("assets/fonts/determination.woff2") format("woff2");
            font-weight: 300; font-style: normal; font-display: swap;
        }
        body, html, *:not(iframe) {
            font-family: "determination", monospace, sans-serif;
            image-rendering: pixelated; text-rendering: optimizeSpeed; 
            -webkit-font-smoothing: none; font-smooth: never;
        }
        body {
            background-color: black; color: white;
            user-select: none;
        }
        audio {display: none}
        .hidecursor, .hidecursor * {
            cursor: none !important;
        }
        *:focus {outline: none !important}


        .site {
            position: fixed; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            top: 50%; left: 50%; aspect-ratio: 4 / 3; 
            width: min(calc(100vw - 32px), calc((100vh - 32px) * 4 / 3), 80vw);
            height: min(calc(100vh - 32px), calc((100vw - 32px) * 3 / 4), calc(0.75 * 80vw));
            max-width: calc(100vw - 32px); max-height: calc(100vh - 32px);
            transform: translate(-50%, -50%);
            outline: 2px white solid; box-sizing: border-box;
            font-size: calc(0.5 * (min(calc(100vw - 32px), calc((100vh - 32px) * 4 / 3), 80vw) / 32));
            text-align: center;
        }
        .loading {
            position: fixed; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            overflow: hidden; opacity: 0; z-index: 99999;
        }
        .white {
            position: fixed; display: flex;
            width: 100%; height: 100%; opacity: 0;
            background-color: white; z-index: 9999;
            transition: opacity 3s;
        }

        .intro {
            position: fixed; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            width: 90%; height: 100%; opacity: 0; transform: translateY(-40px);
            transition: opacity 1s cubic-bezier(0.4,0,0.2,1), transform 1s cubic-bezier(0.4,0,0.2,1);
        }
        .nope {
            position: fixed; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            width: 75%; height: 100%; opacity: 0; text-align: left
        }
        .intro.fade, .nope.fade {
            opacity: 1;
            transform: translateY(0);
        }

        .menu {
            position: fixed; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            width: 100%; height: 100%; opacity: 0;
            overflow: hidden;
        }

        /*//////////////////////////////////////////////////////////////*/

        .chapters {
            display: flex; flex-direction: column;
            width: 100%; height: 100%;
        }
        .chapter {
            display: flex; flex-direction: row; align-items: center;
            width: 100%; border-bottom: 2px #363636 solid;
        }
        .chapter:first-child {padding-top: 2.5px}
        .chapter:last-child {border-bottom: none}
        .unavailable {opacity: 0.5}
        .chapter.selected {
            color: #FFFF3C;
        }
        .chapter.selected .number a,
        .chapter.selected .name a {
            color: #FFFF3C;
        }

        .number {
            display: flex; align-items: center; justify-content: center; 
            width: 35%
        }
        .name {
            display: flex; align-items: center; justify-content: center; 
            width: 45%
        }

        .choice {
            position: fixed; display: flex; align-items: center; justify-content: center; 
            width: 45%; left: 35%; gap: 25%; display: none;
        }
        .choice a {
            color: white;
            transition: color 0.1s;
        }
        .choice a.selected {
            color: #FFFF3C;
        }

        .icon {
            display: flex; align-items: center; justify-content: center; 
            width: 20%; height: 100%
        }
        .icon img {height: 75%}

        /*//////////////////////////////////////////////////////////////*/

        .piano {
            position: fixed; display: flex;
            bottom: 12.3%; height: 25%;
        }
        .note {
            position: absolute;
            height: 2em; left: 50%; top: 0px;
            transform: translateY(0px) scale(1); opacity: 1;
            /* filter: drop-shadow(0 0 0 black) drop-shadow(0 0 0 black) drop-shadow(0 0 4px black) drop-shadow(0 0 2px black);*/
            transition: none; pointer-events: none;
        }
        .bottom {
            position: fixed; display: flex; flex-direction: row;
            justify-content: center; align-items: center;
            bottom: 0; width: 100%;
            border-top: 2px #363636 solid;
        }
        .buttons {
            display: flex; justify-content: center; align-items: center;
            gap: 50%
        }
        .buttons a.selected {
            color: #FFFF3C;
        }

        .info {
            position: fixed; display: flex; flex-direction: column;
            left: 2.5em; text-align: left; line-height: 1.3;
        }
        .chapter, .bottom {
            height: 12%;
        } 

        .heart {
            position: fixed; display: flex;
            height: 1.7em; left: 3.5em; top: 2em;
        }

        /* a {
            text-shadow: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256))
            min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256)) 0 #0F0F71;
        } */
        a span {text-shadow: none}
        .small {
            font-size: calc(0.25 * min(calc((100vw - 32px) / 32), calc(((100vh - 32px) * 4 / 3) / 32), calc(80vw / 32)));
            opacity: 0.5; line-height: 2.5;
        }

        /*//////////////////////////////////////////////////////////////*/

        span[r] {position: relative; display: inline-block; font-weight: bold}
        span[r]::before {content: attr(t); position: absolute; color: #4C0000; z-index: -1;
        top: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256));
        left: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256))}
        span[r]::after {content: attr(t); background: linear-gradient(to bottom, #FFC3C3 0%, #FF3C3C 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text}

        span[g] {position: relative; display: inline-block; font-weight: bold}
        span[g]::before {content: attr(t); position: absolute; color: #004C00; z-index: -1;
        top: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256));
        left: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256))}
        span[g]::after {content: attr(t); background: linear-gradient(to bottom, #A8FFA8 0%, #17FF17 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text}

        span[b] {position: relative; display: inline-block; font-weight: bold}
        span[b]::before {content: attr(t); position: absolute; color: #00004C; z-index: -1;
        top: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256));
        left: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256))}
        span[b]::after {content: attr(t); background: linear-gradient(to bottom, #C3C3FF 0%, #3C3CFF 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text}

        span[y] {position: relative; display: inline-block; font-weight: bold}
        span[y]::before {content: attr(t); position: absolute; color: #4C4C00; z-index: -1;
        top: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256));
        left: min(calc((100vw - 32px) / 256), calc(((100vh - 32px) * 4 / 3) / 256), calc(80vw / 256))}
        span[y]::after {content: attr(t); background: linear-gradient(to bottom, #FFFFC3 0%, #FFFF3C 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text}

    </style>

</head>
<body>

    <audio class="revival" src="assets/audio/snd_revival.ogg" preload="auto"></audio>
    <audio class="menumove" src="assets/audio/snd_menumove.ogg" preload="auto"></audio>

    <audio class="menuselect" src="assets/audio/select/snd_select.wav" preload="auto"></audio>
    <audio class="menuswing" src="assets/audio/snd_swing.wav" preload="auto"></audio>

    <audio class="menuch1" src="assets/audio/select/ch1_select.wav" preload="auto"></audio>
    <audio class="menuch2" src="assets/audio/select/ch2_select.wav" preload="auto"></audio>
    <audio class="menuch3" src="assets/audio/select/ch3_select.wav" preload="auto"></audio>
    <audio class="menuch4" src="assets/audio/select/ch4_select.wav" preload="auto"></audio>

    <div class="site">
        <div class="white"></div>

        <div class="loading">
            <a>Loading<span class="loadingdots"></span></a>
            <a class="small">This process might take a while on low-end devices.</a>
        </div>

        <div class="nope">
            <a>
                <span r t="WARNING" style="text-decoration:underline;text-decoration-color:#4C0000"></span> <br><br>
                IT IS A SERIOUS CRIME TO COPY VIDEO GAMES. <br>
                18 USC 2319 <br>
                PLEASE REFER TO YOUR NINTENDO GAME INSTRUCTION BOOKLET FOR FURTHER INFORMATION. <br>
            </a>
        </div>

        <div class="intro">
            <a>please paste or drag <span b t="igor.output.manifest"></span> from your DELTARUNE installation.</a>
            <a class="small">C:\Program Files (x86)\Steam\steamapps\common\DELTARUNE</a>
        </div>

        <div class="menu" tabindex="0">

            <div class="heart">
                <img src="assets/images/spr_heart.png">
            </div>

            <div class="chapters">
                <div class="chapter">
                    <div class="number"><a>Chapter 1</a></div>
                    <div class="name"><a>The Beginning</a></div>
                    <div class="choice"><a>Play</a><a>Do Not</a></div>
                    <div class="icon"><img src="assets/images/chapters/spr_chapterIcon_1.png"></div>
                </div>
                <div class="chapter">
                    <div class="number"><a>Chapter 2</a></div>
                    <div class="name"><a>A Cyber's World</a></div>
                    <div class="choice"><a>Play</a><a>Do Not</a></div>
                    <div class="icon"><img src="assets/images/chapters/spr_chapterIcon_2.png"></div>
                </div>
                <div class="chapter">
                    <div class="number"><a>Chapter 3</a></div>
                    <div class="name"><a>Late Night</a></div>
                    <div class="choice"><a>Play</a><a>Do Not</a></div>
                    <div class="icon"><img src="assets/images/chapters/spr_chapterIcon_3.png"></div>
                </div>
                <div class="chapter">
                    <div class="number"><a>Chapter 4</a></div>
                    <div class="name"><a>Prophecy</a></div>
                    <div class="choice"><a>Play</a><a>Do Not</a></div>
                    <div class="icon"><img src="assets/images/chapters/spr_chapterIcon_5.png"></div>
                </div>
                <div class="chapter unavailable">
                    <div class="number"><a>Chapter 5</a></div>
                    <div class="name"><a>--</a></div>
                    <div class="icon"><img src="assets/images/chapters/spr_chapterIcon_0.png"></div>
                </div>
                <div class="chapter unavailable">
                    <div class="number"><a>Chapter 6</a></div>
                    <div class="name"><a>--</a></div>
                    <div class="icon"><img src="assets/images/chapters/spr_chapterIcon_0.png"></div>
                </div>
                <div class="chapter unavailable">
                    <div class="number"><a>Chapter 7</a></div>
                    <div class="name"><a>--</a></div>
                    <div class="icon"><img src="assets/images/chapters/spr_chapterIcon_0.png"></div>
                </div>
            </div>

            <div class="piano">
                <img src="assets/images/spr_noellehouse_kitchen_piano.png">
                <img class="note" src="assets/images/spr_noteo_small.png" style="display:none">
            </div>
            <div class="bottom">
                <div class="info small">
                    <a>Underanalyzer by Underminers Team</a>
                    <a>Port by genizy & bog <span b t="(Temporary)"></span></a>
                    <a>Activity by cv</a>
                </div>
                <div class="buttons"><a>Quit</a><a>Buy</a></div>
            </div>
        </div>

    </div>

    <script>
        window.addEventListener("DOMContentLoaded", function() {
            var discord = /discords/.test(window.location.hostname);
            if (typeof debug === "undefined" || (debug < 1)) {
                if (!discord) {
                    var nope = document.querySelector(".nope");
                    var intro = document.querySelector(".intro");
                    if (nope) {void nope.offsetWidth; nope.classList.add("fade")}
                    if (intro) intro.classList.remove("fade");
                    return;
                }
            }
            if (debug !== 4) {
                setTimeout(function() {
                    var intro = document.querySelector(".intro");
                    if (intro) intro.classList.add("fade");
                }, 750);
            }

            const loadingdots = document.querySelector('.loadingdots');
            if (loadingdots) {
                let dotcount = 0;
                setInterval(() => {
                    dotcount = (dotcount + 1) % 4;
                    loadingdots.textContent = '.'.repeat(dotcount);
                }, 400);
            }
        });

        //////////////////////////////////////////////////////////////////
        
        function checkfile(file) {
            const name = file.name.toLowerCase();
            if (!(name.endsWith(".manifest") || name.startsWith("igor.") || name.includes(".output."))) return;
            const reader = new FileReader();
            reader.onload = evt => {
                if (evt.target.result && evt.target.result.indexOf("GameMakerStudio2-LTS") !== -1)
                    validfile(evt.target.result, file.name);
            };
            reader.readAsText(file);
        }
        // dragged file
        document.addEventListener("dragover", e => e.preventDefault());
        document.addEventListener("drop", e => {
            e.preventDefault();
            if (e.dataTransfer?.files?.length) {
                Array.from(e.dataTransfer.files).forEach(checkfile);
            }
        });
        // pasted text
        document.addEventListener("paste", e => {
            if (e.clipboardData?.files?.length) {
                Array.from(e.clipboardData.files).forEach(checkfile);
            } else if (e.clipboardData?.getData) {
                const t = e.clipboardData.getData("text/plain");
                if (t && t.indexOf("GameMakerStudio2-LTS") !== -1)
                    validfile(t, null);
            }
        });

        // 0 = normal, 1 = validfile(), 2 = launch(), 3 = launch instantly, 4 = skip url check
        let debug = 0;
        function validfile(content, fileName) {
            document.querySelector(".intro").classList.remove("fade");
            document.querySelector(".revival").play()
            const speed = (debug === 1) ? 0.5 : 1;
            setTimeout(function() {
                document.querySelector(".white").style.opacity = "1";
                setTimeout(function() {
                    document.querySelector(".white").style.opacity = "0";
                    setTimeout(function() {launch()}, 4000 * speed);
                }, 2000 * speed);
            }, 600 * speed);
        }
        if (debug === 1) {
            let debugvalid = false;
            window.addEventListener("click", function debugValidfileHandler() {
                if (!debugvalid) {debugvalid = true; validfile("GameMakerStudio2-LTS", "debugfile.manifest")}
            }, { once: true });
        } else if (debug === 2) {
            let debuglaunch = false;
            window.addEventListener("click", function debugLaunchHandler() {
                if (!debuglaunch) {debuglaunch = true; launch();}
            }, { once: true });
        } else if (debug === 3) {
            setTimeout(function() {launch()},100);
        } else if (debug === 4) {
            setTimeout(function() {
                var intro = document.querySelector(".intro");
                if (intro) intro.classList.add("fade");
            }, 750);
        }

        //////////////////////////////////////////////////////////////////

        // piano logic
        // notes are based on the ones used on the rejected tracks page:
        // https://toby.fangamer.com/interviews/chapter2_music/

        // i just happened to remember them because deltarune.com's 
        // 2nd sweepstakes arg code had them reimplemented for some reason

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        const piano = [
            {url: "assets/audio/piano/kris_piano_waitingroom.ogg", bpm: 144/2},
            {url: "assets/audio/piano/kris_piano_sevenfour.ogg", bpm: 136/2},
            {url: "assets/audio/piano/kris_piano_prophecy.ogg", bpm: 125/2},
            {url: "assets/audio/piano/kris_piano_shop.ogg", bpm: 84/2},
            {url: "assets/audio/piano/kris_piano_quiz.ogg", bpm: 79/2},
            {url: "assets/audio/piano/kris_piano_rouxls.ogg", bpm: 144/2},
            {url: "assets/audio/piano/kris_piano_lancer_waltz.ogg", bpm: 89/2},
            {url: "assets/audio/piano/kris_piano_last_prophecy.ogg", bpm: 76/2},
            {url: "assets/audio/piano/kris_piano_lower.ogg", bpm: 99/2}
        ];

        let shuffled = []; let currentindex = 0;
        let notetimeout = null;
        let currentbpm = 120;
        let currentpianosong = null;
        let pianostopped = false;

        function spawnnote() {
            if (pianostopped) return;
            const pianoelement = document.querySelector(".piano");
            if (!pianoelement) return; const notetemplate = pianoelement.querySelector(".note");
            if (!notetemplate) return; const note = notetemplate.cloneNode(true);
            note.style.display = ""; note.style.left = (10 + Math.random() * 80) + "%";
            const duration = 1100 + Math.random() * 400; const scale = 0.8 + Math.random() * 0.4;
            note.animate([
                {transform: `translateY(0px) scale(1)`, opacity: 1},
                {transform: `translateY(-60px) scale(${scale})`, opacity: 0}
            ], {
                duration: duration,
                easing: "ease-in-out",
                fill: "forwards"
            }).onfinish = () => {note.remove()};
            pianoelement.appendChild(note);
            notetimeout = setTimeout(spawnnote, 60000 / currentbpm);
        }
        function playnext() {
            if (pianostopped) return;
            if (notetimeout) { clearTimeout(notetimeout); notetimeout = null; }
            if (currentindex >= shuffled.length) {shuffled = shuffle(piano.slice()); currentindex = 0}
            const entry = shuffled[currentindex]; currentindex++;
            currentbpm = entry.bpm || 120;
            if (currentpianosong) { currentpianosong.onended = null; currentpianosong = null; }
            currentpianosong = new Audio(entry.url);
            currentpianosong.volume = 1;
            currentpianosong.play();
            currentpianosong.onended = playnext;
            spawnnote();
        }
        function launch() {
            stoppiano();
            pianostopped = false;
            document.querySelector(".intro").style.display = "none"; // just in case
            const menu = document.querySelector(".menu"); menu.style.opacity = "1";
            document.documentElement.classList.add("hidecursor");
            document.body.classList.add("hidecursor");
            menu.focus();
            shuffled = shuffle(piano.slice()); currentindex = 0; playnext();
        }

        //////////////////////////////////////////////////////////////////

        let currentchapter = 0; let currentchoice = 0; let currentbottom = 0;
        let inchoice = false; let inbottom = false;
        
        function updatechapter() {
            const chapters = Array.from(document.querySelectorAll(".menu .chapter"));
            chapters.forEach((ch, i) => {
                ch.classList.toggle("selected", i === currentchapter && !inbottom);
                const img = ch.querySelector(".icon img");
                if (!img) return;
                if (i === currentchapter && !inbottom) {
                    if (!img.dataset.originalSrc) img.dataset.originalSrc = img.src;
                    recolor(img);
                } else if (img.dataset.originalSrc) {
                    img.src = img.dataset.originalSrc;
                }
                const choice = ch.querySelector(".choice");
                if (choice) choice.style.display = (i === currentchapter && inchoice && !inbottom) ? "flex" : "none";
                const name = ch.querySelector(".name");
                if (name) name.style.visibility = (i === currentchapter && inchoice && !inbottom) ? "hidden" : "";
                if (choice) {
                    const choices = choice.querySelectorAll("a");
                    choices.forEach((c, idx) => {
                        if (inchoice && currentchoice === idx && !inbottom) c.classList.add("selected");
                        else c.classList.remove("selected");
                    });
                }
            });

            const buttons = document.querySelectorAll(".buttons a");
            buttons.forEach((btn, idx) => {
                if (inbottom && idx === currentbottom) btn.classList.add("selected");
                else btn.classList.remove("selected");
            });
            const heart = document.querySelector(".menu > .heart");
            if (heart) {
                if (inbottom) {
                    const buttons = document.querySelectorAll(".buttons a");
                    const button = buttons[currentbottom];
                    const menurect = document.querySelector(".menu").getBoundingClientRect();
                    const buttonrect = button.getBoundingClientRect();
                    heart.style.top = (buttonrect.top - menurect.top + buttonrect.height / 2 - heart.offsetHeight / 2) + "px";
                    let offset = 0;
                    if (currentbottom === 0) {offset = buttonrect.width * 0.95} // quit
                    else if (currentbottom === 1) {offset = buttonrect.width * 1.05} // buy
                    heart.style.left = (buttonrect.left - menurect.left + buttonrect.width / 2 - heart.offsetWidth / 2 - offset) + "px";
                } else if (inchoice) {
                    const chapters = document.querySelectorAll(".menu .chapter");
                    const chapter = chapters[currentchapter];
                    const choice = chapter.querySelector(".choice");
                    if (choice) {
                        const menurect = document.querySelector(".menu").getBoundingClientRect();
                        const choiceRect = choice.getBoundingClientRect();
                        let offset = 0;
                        if (currentchoice === 0) offset = choiceRect.width * 0.125; // play
                        else offset = choiceRect.width * 0.54; // do not
                        heart.style.top = (choiceRect.top - menurect.top + choiceRect.height / 2 - heart.offsetHeight / 2) + "px";
                        heart.style.left = (choiceRect.left - menurect.left + offset - heart.offsetWidth * 0.7) + "px";
                    }
                } else {
                    const chapters = document.querySelectorAll(".menu .chapter");
                    const chapter = chapters[currentchapter];
                    const chapterRect = chapter.getBoundingClientRect();
                    const menurect = document.querySelector(".menu").getBoundingClientRect();
                    heart.style.top = (chapterRect.top - menurect.top + chapterRect.height / 2 - heart.offsetHeight / 2) + "px";
                    heart.style.left = "";
                }
            }
        }
        function highlightchapter(dir) {
            if (inchoice) return;
            const chapters = Array.from(document.querySelectorAll(".menu .chapter"));
            const len = chapters.length;
            if (!inbottom) {
                let next = currentchapter + dir; let found = false; let idx = next;
                while (idx >= 0 && idx < len) {
                    if (!chapters[idx].classList.contains("unavailable")) {
                        found = true; break;
                    }; idx += dir;
                }
                if (!found) {
                    inbottom = true; currentbottom = 0;
                    updatechapter(); document.querySelector(".menumove").play();
                    return;
                } else {
                    currentchapter = idx;
                    updatechapter(); document.querySelector(".menumove").play();
                    return;
                }
            } else {
                if (dir < 0) {
                    let idx = len - 1;
                    while (chapters[idx].classList.contains("unavailable") && idx > 0) idx--;
                    currentchapter = idx;
                } else {
                    let idx = 0;
                    while (chapters[idx].classList.contains("unavailable") && idx < len - 1) idx++;
                    currentchapter = idx;
                }
                inbottom = false;
                updatechapter();
                document.querySelector(".menumove").play();
            }
        }
        function highlightchoice(dir) {
            if (!inchoice) return;
            const chapter = document.querySelectorAll(".menu .chapter")[currentchapter];
            const choices = chapter.querySelectorAll(".choice a");
            currentchoice = (currentchoice + dir + choices.length) % choices.length;
            updatechapter();
            document.querySelector(".menumove").play();
        }
        function highlightbottom(dir) {
            if (!inbottom) return;
            const buttons = document.querySelectorAll(".buttons a");
            const len = buttons.length;
            currentbottom = (currentbottom + dir + len) % len;
            updatechapter();
            document.querySelector(".menumove").play();
        }

        //////////////////////////////////////////////////////////////////

        document.addEventListener("keydown", function(e) {
            if (document.querySelector(".menu").style.opacity !== "1") return;
            if (inbottom) {
                if (["ArrowLeft", "a", "A"].includes(e.key)) {
                    highlightbottom(-1); e.preventDefault();
                } else if (["ArrowRight", "d", "D"].includes(e.key)) {
                    highlightbottom(1); e.preventDefault();
                } else if (["z", "Z", "Enter"].includes(e.key)) {
                    if (currentbottom === 0) {
                        if (window?.DiscordNative?.activity?.close) {
                            window.DiscordNative.activity.close();
                            return;
                        }
                    } else {
                        const url = "https://deltarune.com/#:~:text=AVAILABLE%20NOW";
                        const win = window.open(url, "_blank");
                        if (!win) {
                            if (navigator.clipboard && window.isSecureContext) {navigator.clipboard.writeText(url)}
                            alert("Failed to open the page... The URL has been copied to your clipboard:\n" + url);
                        }
                    }
                    document.querySelector(".menuselect").play();
                    e.preventDefault();
                } else if (e.key === "ArrowUp") {
                    highlightchapter(-1); e.preventDefault();
                } else if (e.key === "ArrowDown") {
                    highlightchapter(1); e.preventDefault();
                }
                return;
            }
            if (inchoice) {
                if (["ArrowLeft", "a", "A"].includes(e.key)) {
                    highlightchoice(-1); e.preventDefault();
                } else if (["ArrowRight", "d", "D"].includes(e.key)) {
                    highlightchoice(1); e.preventDefault();
                } else if (["z", "Z", "Enter"].includes(e.key)) {
                    if (currentchoice === 0) {
                        if (currentchapter === 0) { // ch1
                            funnymenu(); stoppiano();
                            document.querySelector(".menuch1").play();
                            setTimeout(() => {loading(); runchapter(1)}, 2000);
                        }
                        if (currentchapter === 1) { // ch2
                            funnymenu(); stoppiano(); 
                            document.querySelector(".menuch2").play();
                            setTimeout(() => {loading(); runchapter(2)}, 2000);
                        }
                        if (currentchapter === 2) { // ch3
                            funnymenu(); stoppiano(); 
                            document.querySelector(".menuch3").play();
                            setTimeout(() => {loading(); runchapter(3)}, 2000);
                        }
                        if (currentchapter === 3) { // ch4
                            funnymenu(); stoppiano(); 
                            document.querySelector(".menuch4").play();
                            setTimeout(() => {loading(); runchapter(4)}, 2000);
                        }
                        document.querySelector(".menuselect").play();
                    } else {
                        inchoice = false; updatechapter();
                        document.querySelector(".menuselect").play();
                    }
                    e.preventDefault();
                } else if (["x", "X", "Shift"].includes(e.key)) {
                    inchoice = false;
                    updatechapter();
                    document.querySelector(".menuswing").play();
                    e.preventDefault();
                }
                return;
            }
            if (e.key === "ArrowDown") {
                highlightchapter(1); e.preventDefault();
            }
            else if (e.key === "ArrowUp") {
                highlightchapter(-1); e.preventDefault();
            } else if (["z", "Z", "Enter"].includes(e.key)) {
                const chapter = document.querySelectorAll(".menu .chapter")[currentchapter];
                if (chapter.classList.contains("unavailable")) return;
                inchoice = true; currentchoice = 0;
                updatechapter(); document.querySelector(".menuselect").play();
                e.preventDefault();
            }
        });
        function funnymenu() {
            const menu = document.querySelector(".menu");
            menu.style.transition = "transform 1s linear, opacity 1s linear";
            menu.style.transformOrigin = "top center"; menu.style.overflow = "hidden";
            void menu.offsetWidth; menu.style.transform = "scaleX(0) scaleY(0.75)";
            menu.style.opacity = "0";
            setTimeout(() => {menu.style.display = "none"}, 1000);
        }

        const oglaunch = launch;
        launch = function() {
            oglaunch();
            setTimeout(updatechapter, 100);
        }

        // recolor with js because css is ASS at this
        function recolor(img) {
            const canvas = document.createElement("canvas"); const ctx = canvas.getContext("2d");
            const iconcopy = new window.Image(); iconcopy.crossOrigin = "anonymous";
            iconcopy.onload = function() {
                canvas.width = iconcopy.width;
                canvas.height = iconcopy.height;
                ctx.drawImage(iconcopy, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] > 220 && data[i+1] > 220 && data[i+2] > 220 && data[i+3] > 0) {
                        data[i] = 255; data[i+1] = 255; data[i+2] = 60;
                    }
                }
                ctx.putImageData(imageData, 0, 0);
                img.src = canvas.toDataURL();
            }; iconcopy.src = img.dataset.originalSrc || img.src;
        }

        //////////////////////////////////////////////////////////////////

        function stoppiano() {
            pianostopped = true;
            if (notetimeout) { clearTimeout(notetimeout); notetimeout = null; }
            if (currentpianosong) {
                let fadeInterval = setInterval(() => {
                    if (currentpianosong.volume > 0.05) {
                        currentpianosong.volume -= 0.05;
                    } else {
                        currentpianosong.volume = 0;
                        currentpianosong.pause();
                        currentpianosong = null;
                        clearInterval(fadeInterval);
                    }
                }, 50);
            }
        }

        function loading() {
            const loading = document.querySelector('.loading');
            if (loading) {
                loading.style.transition = 'opacity 0.5s';
                loading.style.opacity = '0.5';
            }
            setTimeout(() => {
                if (loading) loading.style.opacity = '0';
            }, 4000);
        }

        function runchapter(chapternum) {

            const gameframe = document.querySelector(".gameframe");
            if (gameframe) gameframe.remove();

            const site = document.querySelector(".site");
            const rect = site.getBoundingClientRect();

            const iframe = document.createElement("iframe");
            iframe.className = "gameframe";
            iframe.src = `data/ch${chapternum}/index.html`;
            iframe.tabIndex = 0; iframe.onload = function() {iframe.focus()};

            iframe.style.position = "fixed";
            iframe.style.top = rect.top + "px"; iframe.style.left = rect.left + "px";
            iframe.style.width = rect.width + "px"; iframe.style.height = rect.height + "px";
            iframe.style.border = "none"; iframe.allow = "autoplay; fullscreen";
            iframe.style.zIndex = "-1"

            document.body.appendChild(iframe);

            aligngameframe();
            if (!window._gameframeResizeListener) {
                window.addEventListener("resize", aligngameframe);
                window.addEventListener("scroll", aligngameframe);
                window._gameframeResizeListener = true;
            }
            
        }
        function aligngameframe() {
            const site = document.querySelector(".site");
            const iframe = document.querySelector(".gameframe");
            if (!site || !iframe) return; const rect = site.getBoundingClientRect();
            iframe.style.top = rect.top + "px"; iframe.style.left = rect.left + "px";
            iframe.style.width = rect.width + "px"; iframe.style.height = rect.height + "px";
        }
    </script>
</body>
</html>